Proof of concept for retrieving sequence files (sam, bam, cram) via a streaming service
=======================================================================================

====INSTALL DEPENDENCIES

npm install

====GENERATE DOCUMENTATION

grunt jsdoc

====TEST

grunt test - runs all tests
grunt jasmine_nodejs

====RUN

----Connect to iRODs if not already connected

----Ensure that samtools v1.3 is on your path

----Run server on the default socket /tmp/${USER}/npg_ranger.sock
bin/server.js

----Run server on a custom port 9447
bin/server.js 9447

----Run server on a custom port and skip authentication
bin/server.js -p PORT -s

----Run server on a custom socket
bin/server.js /tmp/my.sock

====EXAMPLES AND COMPATIBLE CLIENTS

----curl
curl -H "Content-type: application/octet-stream" -X "GET" 'localhost:9444/sample?region=Zv9_scaffold3541&accession=ERS1023809'
  no files found - an empty reply
  one file found - an outcome of samtools view
  multiple files found - an outcome of samtools merge

curl -H "Content-type: application/octet-stream" -X "GET" 'localhost:9444/file?directory=/seq/18691&region=Zv9_scaffold3541&irods=1&name=18691_1%231.cram'
curl -H "Content-type: application/octet-stream" -X "GET" 'localhost:9444/file?directory=/staging/path&region=Zv9_scaffold3541&name=18691_1%231.cram'

The default output format is bam. Use 'format' option with value either 'sam' or 'bam' or 'cram' to change the output format.

----bin/client.js (this project)
A simple trailer header aware client that works with with a socket server.

----Biodalliance
A custom npg_ranger track is added to the Biodalliance genome browser
https://github.com/wtsi-npg/dalliance

====Authentication
Should be done by a front server

====Authorisation
It is expected that the incoming request has X-Remote-User header set. The data will be served if the remote user has 'read' permission for alll files that have to be merged/served.

====TODO LIST

Compute md5 and send it in a trailer.

Nodejs client to pipe through; in - url, out - stream, log all urls and errors, including trailer headers.

following from GA4GH teleconf on 22.04.2016
-------------------------------------------
prefix/suffix for head-less url, do generically to allow for further prefixes/suffuxes
use query params from the spec
syncronise error codes with the spec


====APACHE REVERSE PROXY

Setting up the server
---------------------

wget http://mirrors.ukfast.co.uk/sites/ftp.apache.org//httpd/httpd-2.4.18.tar.gz
tar -xzvf httpd-2.4.18.tar.gz
cd httpd-2.4.18
./configure --enable-load-all-modules --prefix=${HOME}/apache_build
make 
make install
cd ${HOME}/apache_build
vi conf/httpd.conf # edit the file

From anywhere
${HOME}/apache_build/bin/httpd -k start

LDAP authorisation config
-------------------------
 <Location / >
	AuthType Basic
	AuthBasicProvider ldap 
	AuthName "LDAP Login For NPG Streaming"
	AuthLDAPURL "sanger ldap string"
	Require valid-user
	AuthLDAPRemoteUserAttribute uid
	RewriteEngine On
        RewriteRule .* - [E=PROXY_USER:%{LA-U:REMOTE_USER},NS]
	RequestHeader set X-Remote-User %{PROXY_USER}e
  </Location>

Reverse proxy config
--------------------
  ProxyPreserveHost On
  # to a local server listening on a unix socket, requires Apache v 2.4.7 at least
  ProxyPass /        unix:/path_to/my.socket|http://localhost/
  ProxyPassReverse / unix:/path_to/my.socket|http://localhost/
  # To a local URL
  #ProxyPass /        http://localhost:9030/
  #ProxyPassReverse / http://localhost:9030/





